# Домашнее задание к занятию  «Очереди RabbitMQ - Рыхлик ИА»

---

### Задание 1. Установка RabbitMQ

Используя Vagrant или VirtualBox, создайте виртуальную машину и установите RabbitMQ.
Добавьте management plug-in и зайдите в веб-интерфейс.

*Итогом выполнения домашнего задания будет приложенный скриншот веб-интерфейса RabbitMQ.*

---

### Задание 1. Установка RabbitMQ

Развернем виртуальную машину в среде VirtualBox н7а основе дистридутива Ubuntu Server 24.04

Для установки воспользуемся инструкцией на сайте rabbitmq
https://www.rabbitmq.com/docs/install-debian
создадим файл rabbit.sh 

```shell
#!/bin/sh

sudo apt-get install curl gnupg apt-transport-https -y

## Team RabbitMQ's signing key
curl -1sLf "https://keys.openpgp.org/vks/v1/by-fingerprint/0A9AF2115F4687BD29803A206B73A36E6026DFCA" | sudo gpg --dearmor | sudo tee /usr/share/keyrings/com.rabbitmq.team.gpg > /dev/null

## Add apt repositories maintained by Team RabbitMQ
sudo tee /etc/apt/sources.list.d/rabbitmq.list <<EOF
## Modern Erlang/OTP releases
##
deb [arch=amd64 signed-by=/usr/share/keyrings/com.rabbitmq.team.gpg] https://deb1.rabbitmq.com/rabbitmq-erlang/ubuntu/noble noble main
deb [arch=amd64 signed-by=/usr/share/keyrings/com.rabbitmq.team.gpg] https://deb2.rabbitmq.com/rabbitmq-erlang/ubuntu/noble noble main

## Latest RabbitMQ releases
##
deb [arch=amd64 signed-by=/usr/share/keyrings/com.rabbitmq.team.gpg] https://deb1.rabbitmq.com/rabbitmq-server/ubuntu/noble noble main
deb [arch=amd64 signed-by=/usr/share/keyrings/com.rabbitmq.team.gpg] https://deb2.rabbitmq.com/rabbitmq-server/ubuntu/noble noble main
EOF

## Update package indices
sudo apt-get update -y

## Install Erlang packages
sudo apt-get install -y erlang-base \
                        erlang-asn1 erlang-crypto erlang-eldap erlang-ftp erlang-inets \
                        erlang-mnesia erlang-os-mon erlang-parsetools erlang-public-key \
                        erlang-runtime-tools erlang-snmp erlang-ssl \
                        erlang-syntax-tools erlang-tftp erlang-tools erlang-xmerl

## Install rabbitmq-server and its dependencies
sudo apt-get install rabbitmq-server -y --fix-missing
```
выполним script

Проверим запущена ли у нас служба 
![11-04-01](https://github.com/ilaryhlik17854-stack/HW_DATABASES/blob/main/4-The_RabbitMQ_queue/img/11-04-01.png?raw=true)

Включаем плагин для Web UI и добавляем пользователя

```
sudo rabbitmq-plugins enable rabbitmq_management
sudo rabbitmqctl add_vhost master
sudo rabbitmqctl add_user admin admin
sudo rabbitmqctl set_user_tags admin administrator
sudo rabbitmqctl set_permissions -p / admin ".*" ".*" ".*"
```
![11-04-02](https://github.com/ilaryhlik17854-stack/HW_DATABASES/blob/main/4-The_RabbitMQ_queue/img/11-04-02.png?raw=true)

---

### Задание 2. Отправка и получение сообщений

Используя приложенные скрипты, проведите тестовую отправку и получение сообщения.
Для отправки сообщений необходимо запустить скрипт producer.py.

Для работы скриптов вам необходимо установить Python версии 3 и библиотеку Pika.
Также в скриптах нужно указать IP-адрес машины, на которой запущен RabbitMQ, заменив localhost на нужный IP.

```shell script
$ pip install pika
```

Зайдите в веб-интерфейс, найдите очередь под названием hello и сделайте скриншот.
После чего запустите второй скрипт consumer.py и сделайте скриншот результата выполнения скрипта

*В качестве решения домашнего задания приложите оба скриншота, сделанных на этапе выполнения.*

Для закрепления материала можете попробовать модифицировать скрипты, чтобы поменять название очереди и отправляемое сообщение.

---

### Решение 2. Отправка и получение сообщений

Для отправки сообщенией модифицирем предоставленные в задание скрипты

скрипт producer.py
``` 
#!/usr/bin/env python
# coding=utf-8
import pika
credentials = pika.PlainCredentials('admin', 'admin')
parameters = pika.ConnectionParameters('192.168.100.163',
                                   5672,
                                   '/',
                                   credentials)
connection = pika.BlockingConnection(parameters)
channel = connection.channel()
channel.queue_declare(queue='hello')
channel.basic_publish(exchange='', routing_key='hello', body='Hello Rukhlik IA student Netology!')
connection.close()
```
запускаем скрипт для добавления сообщения с очереди 
```
python3 C:\\producer.py
```
Смотрим как сообщения добавляются в очередь
![11-04-03](https://github.com/ilaryhlik17854-stack/HW_DATABASES/blob/main/4-The_RabbitMQ_queue/img/11-04-03.png?raw=true)

запускаем скрипт для того чтобы забрать наши ссобщения

скритп consumer.py
```
#!/usr/bin/env python
# coding=utf-8
import pika
credentials = pika.PlainCredentials('admin', 'admin')
parameters = pika.ConnectionParameters('192.168.100.163',
                                   5672,
                                   '/',
                                   credentials)
connection = pika.BlockingConnection(parameters)
channel = connection.channel()
channel.queue_declare(queue='hello')


def callback(ch, method, properties, body):
    print(" [x] Received %r" % body)


channel.basic_consume(on_message_callback=callback, queue='hello', auto_ack=True)
channel.start_consuming()
```
запустим скрипт
```
python3 C:\\consumer.py
```
![11-04-04](https://github.com/ilaryhlik17854-stack/HW_DATABASES/blob/main/4-The_RabbitMQ_queue/img/11-04-04.png?raw=true)

![11-04-05](https://github.com/ilaryhlik17854-stack/HW_DATABASES/blob/main/4-The_RabbitMQ_queue/img/11-04-05.png?raw=true)

---

### Задание 3. Подготовка HA кластера

Используя Vagrant или VirtualBox, создайте вторую виртуальную машину и установите RabbitMQ.
Добавьте в файл hosts название и IP-адрес каждой машины, чтобы машины могли видеть друг друга по имени.

Пример содержимого hosts файла:
```shell script
$ cat /etc/hosts
192.168.0.10 rmq01
192.168.0.11 rmq02
```
После этого ваши машины могут пинговаться по имени.

Затем объедините две машины в кластер и создайте политику ha-all на все очереди.

*В качестве решения домашнего задания приложите скриншоты из веб-интерфейса с информацией о доступных нодах в кластере и включённой политикой.*

Также приложите вывод команды с двух нод:

```shell script
$ rabbitmqctl cluster_status
```

Для закрепления материала снова запустите скрипт producer.py и приложите скриншот выполнения команды на каждой из нод:

```shell script
$ rabbitmqadmin get queue='hello'
```

После чего попробуйте отключить одну из нод, желательно ту, к которой подключались из скрипта, затем поправьте параметры подключения в скрипте consumer.py на вторую ноду и запустите его.

*Приложите скриншот результата работы второго скрипта.*

---

### Решение 3. Подготовка HA кластера

Переименум все машины для добавления машину по hostname
скришот файла /etc/hosts  с двух хостов подключаемых в кластер
![11-04-06](https://github.com/ilaryhlik17854-stack/HW_DATABASES/blob/main/4-The_RabbitMQ_queue/img/11-04-06.png?raw=true) ![11-04-07](https://github.com/ilaryhlik17854-stack/HW_DATABASES/blob/main/4-The_RabbitMQ_queue/img/11-04-07.png?raw=true)

для работы в кластере файлы в директории cat /var/lib/rabbitmq/.erlang.cookie на обоих nodes должны быть одинаковы

![11-04-10](https://github.com/ilaryhlik17854-stack/HW_DATABASES/blob/main/4-The_RabbitMQ_queue/img/11-04-10.png?raw=true) ![11-04-11](https://github.com/ilaryhlik17854-stack/HW_DATABASES/blob/main/4-The_RabbitMQ_queue/img/11-04-11.png?raw=true)

скришот комыды с двух nodes
```
sudo rabbitmqctl cluster_status
```
![11-04-08](https://github.com/ilaryhlik17854-stack/HW_DATABASES/blob/main/4-The_RabbitMQ_queue/img/11-04-08.png?raw=true) ![11-04-09](https://github.com/ilaryhlik17854-stack/HW_DATABASES/blob/main/4-The_RabbitMQ_queue/img/11-04-09.png?raw=true)

Kоманда $ rabbitmqadmin get queue='hello' не заработала ни на одной из нод.
```
пользовался инструкцией по установке https://lindevs.com/install-rabbitmqadmin-on-ubuntu
ничего не помагло 
```
Запускаем producer.py на ноду rabbit@rabbitmq-serv1
Запускаем producer2.py на ноду rabbit@rabbitmq-serv2
Скриншот приходы сообщений на обе nodes
![11-04-13](https://github.com/ilaryhlik17854-stack/HW_DATABASES/blob/main/4-The_RabbitMQ_queue/img/11-04-13.png?raw=true) 

![11-04-14](https://github.com/ilaryhlik17854-stack/HW_DATABASES/blob/main/4-The_RabbitMQ_queue/img/11-04-14.png?raw=true) 

Запускаем consumer2.py на ноду rabbit@rabbitmq-serv2

![11-04-15](https://github.com/ilaryhlik17854-stack/HW_DATABASES/blob/main/4-The_RabbitMQ_queue/img/11-04-15.png?raw=true) 

![11-04-16](https://github.com/ilaryhlik17854-stack/HW_DATABASES/blob/main/4-The_RabbitMQ_queue/img/11-04-16.png?raw=true) 

Задание выполнено не корреттно так как не удалось приметь политику 

rabbitmqctl set_policy ha-all
применные команды
sudo rabbitmqctl set_policy ha-all "." '{"ha-mode":"all", "ha-sync-mode":"automatic"}'
sudo rabbitmqctl set_policy ha-all "^ha\." '{"ha-mode":"all"}'
sudo rabbitmqctl set_policy HA ".*" "{""ha-mode"": ""all""}"

![11-04-17](https://github.com/ilaryhlik17854-stack/HW_DATABASES/blob/main/4-The_RabbitMQ_queue/img/11-04-17.png?raw=true) 

так же пробывал через web 

![11-04-18](https://github.com/ilaryhlik17854-stack/HW_DATABASES/blob/main/4-The_RabbitMQ_queue/img/11-04-18.png?raw=true) 

использовал инструкцию на офицальном сайте
![11-04-19](https://github.com/ilaryhlik17854-stack/HW_DATABASES/blob/main/4-The_RabbitMQ_queue/img/11-04-19.png?raw=true) ![11-04-20](https://github.com/ilaryhlik17854-stack/HW_DATABASES/blob/main/4-The_RabbitMQ_queue/img/11-04-20.png?raw=true) 

Сдел удаленный доступ (если есть возможность помочь) сил дальше пытаться выполнить больше нету